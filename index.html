<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Weasel - The Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #B2D8CE 0%, #a0c9bf 100%);
            --secondary-gradient: linear-gradient(135deg, #B2D8CE 0%, #a0c9bf 100%);
            --background-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-border: rgba(148, 163, 184, 0.3);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --accent-color: #f59e0b;
            --accent-glow: rgba(245, 158, 11, 0.4);
            --success-color: #10b981;
            --success-glow: rgba(16, 185, 129, 0.4);
            --error-color: #ef4444;
            --error-glow: rgba(239, 68, 68, 0.4);
            --warning-color: #f97316;
            --warning-glow: rgba(249, 115, 22, 0.4);
            --shadow-light: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 8px 32px rgba(0, 0, 0, 0.12);
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            padding: var(--spacing-lg);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(178, 216, 206, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(245, 158, 11, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        #app-container {
            max-width: 900px;
            margin: 0 auto;
            backdrop-filter: blur(20px);
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            overflow: hidden;
        }

        header {
            background: var(--primary-gradient);
            padding: var(--spacing-2xl) var(--spacing-lg);
            text-align: center;
            position: relative;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
        }

        main {
            padding: var(--spacing-xl) var(--spacing-lg);
        }

        .screen {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Modern Components --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            margin-top: var(--spacing-md);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(178, 216, 206, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(178, 216, 206, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--secondary-gradient);
            box-shadow: 0 4px 16px rgba(178, 216, 206, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 24px rgba(178, 216, 206, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            box-shadow: 0 4px 16px var(--success-glow);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
            box-shadow: 0 4px 16px var(--error-glow);
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius-sm);
            border: 2px solid var(--card-border);
            background: white;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        input::placeholder {
            color: var(--text-muted);
        }
        
        input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* --- Enhanced Player Setup --- */
        #player-inputs {
            margin: var(--spacing-lg) 0;
        }

        .player-input-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            align-items: center;
        }

        .player-input-group::before {
            content: 'üë§';
            font-size: 1.2rem;
            opacity: 0.7;
        }

        /* --- Modern Game Screen --- */
        #game-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg) var(--spacing-lg);
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-light);
        }

        #round-counter {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--accent-color);
            background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #player-scores {
            list-style: none;
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        #player-scores li {
            font-weight: 500;
            padding: var(--spacing-xs) var(--spacing-md);
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border-radius: 20px;
            border: 1px solid var(--card-border);
            transition: var(--transition);
            color: var(--text-primary);
        }

        #player-scores li:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            transform: translateY(-1px);
        }
        
        #player-scores .weasel-score {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
            box-shadow: 0 0 12px var(--error-glow);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* --- Enhanced Word Grid --- */
        #word-grid, #main-word-grid, #reveal-word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .word-cell {
            background: white;
            padding: var(--spacing-lg) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            text-align: center;
            font-size: 0.95rem;
            font-weight: 500;
            border: 2px solid var(--card-border);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }

        .word-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(178, 216, 206, 0.1), transparent);
            transition: left 0.5s;
        }

        .word-cell.secret {
            background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
            color: white;
            font-weight: 700;
            box-shadow: 0 0 24px var(--accent-glow);
            border-color: var(--accent-color);
            animation: secretGlow 3s ease-in-out infinite;
        }

        @keyframes secretGlow {
            0%, 100% { box-shadow: 0 4px 24px var(--accent-glow); }
            50% { box-shadow: 0 8px 32px var(--accent-glow), 0 0 48px rgba(245, 158, 11, 0.2); }
        }
        
        .word-cell.guessable:hover {
            cursor: pointer;
            border-color: var(--accent-color);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);
        }

        .word-cell.guessable:hover::before {
            left: 100%;
        }

        .word-cell.selected-guess {
            border-color: var(--success-color);
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: 0 0 24px var(--success-glow);
            font-weight: 700;
        }
        
        @media (min-width: 768px) {
            #word-grid, #main-word-grid, #reveal-word-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        /* --- Enhanced Phase Screens --- */
        .phase-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .phase-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .phase-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.6;
        }

        /* --- Modern Vote Options --- */
        #vote-options {
            list-style: none;
            margin-top: var(--spacing-lg);
            display: grid;
            gap: var(--spacing-sm);
        }
        
        .vote-option {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--card-border);
            font-weight: 500;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }

        .vote-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(178, 216, 206, 0.1), transparent);
            transition: left 0.5s;
        }

        .vote-option:hover {
            transform: translateX(4px);
            border-color: var(--accent-color);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.2);
        }

        .vote-option:hover::before {
            left: 100%;
        }

        .vote-option.selected-vote {
            background: linear-gradient(135deg, var(--accent-color), var(--warning-color));
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 0 24px var(--accent-glow);
            font-weight: 700;
        }

        /* --- Enhanced Scoring Summary --- */
        #scoring-summary {
            text-align: left;
        }

        #scoring-summary h2 {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            font-size: 1.6rem;
            color: var(--text-primary);
        }

        .outcome-title {
            font-weight: 700;
            font-size: 1.4rem;
            text-align: center;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
        }

        .innocent-win { 
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: 0 0 32px var(--success-glow);
        }
        .weasel-win { 
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
            box-shadow: 0 0 32px var(--error-glow);
        }
        .contested-win { 
            background: linear-gradient(135deg, var(--warning-color), #ea580c);
            color: white;
            box-shadow: 0 0 32px var(--warning-glow);
        }
        .total-failure { 
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            box-shadow: 0 0 32px rgba(100, 116, 139, 0.3);
        }
        
        #player-score-changes {
            list-style: none;
            margin-top: var(--spacing-lg);
            background: white;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--card-border);
            overflow: hidden;
        }

        #player-score-changes li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--card-border);
            transition: var(--transition);
        }

        #player-score-changes li:last-child {
            border-bottom: none;
        }

        #player-score-changes li:hover {
            background: #f8fafc;
        }

        .score-gain { 
            color: var(--success-color);
            font-weight: 700;
        }
        .score-loss { 
            color: var(--error-color); 
            font-weight: 700;
        }
        
        /* --- Enhanced Rules Section --- */
        #rules-container {
            margin-top: var(--spacing-2xl);
        }

        #rules-container summary {
            cursor: pointer;
            padding: var(--spacing-lg);
            background: white;
            border: 2px solid var(--card-border);
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1.1rem;
            outline: none;
            transition: var(--transition);
            user-select: none;
            color: var(--text-primary);
        }

        #rules-container summary:hover {
            background: #f8fafc;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        #rules-container details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
        }

        #rules-content {
            background: white;
            padding: var(--spacing-lg);
            border: 2px solid var(--card-border);
            border-top: none;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            text-align: left;
            line-height: 1.7;
            color: var(--text-primary);
        }

        #rules-content h3 {
            color: var(--accent-color);
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
        }

        #rules-content ul, #rules-content ol {
            padding-left: var(--spacing-lg);
            margin: var(--spacing-sm) 0;
        }

        #rules-content li {
            margin-bottom: var(--spacing-xs);
        }

        #rules-content strong {
            color: var(--warning-color);
            font-weight: 600;
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }

            header {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            header h1 {
                font-size: 2rem;
            }

            main {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            .card {
                padding: var(--spacing-lg);
            }

            #game-info-bar {
                flex-direction: column;
                gap: var(--spacing-md);
                text-align: center;
                padding: var(--spacing-md);
            }

            #player-scores {
                justify-content: center;
                gap: var(--spacing-md);
            }

            .word-cell {
                font-size: 0.85rem;
                padding: var(--spacing-md) var(--spacing-xs);
            }

            #rules-container {
                margin-top: var(--spacing-xl);
            }

            #rules-container summary {
                padding: var(--spacing-md);
            }

            #rules-content {
                padding: var(--spacing-md);
            }
        }

        /* --- Accessibility & Polish --- */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for accessibility */
        *:focus-visible {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--accent-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* --- Buffer Screen --- */
        .buffer-screen {
            text-align: center;
        }
        
        .buffer-screen h2 {
            margin-bottom: var(--spacing-md);
            color: var(--text-secondary);
        }
        
        .buffer-screen p {
            color: var(--text-muted);
            margin-bottom: var(--spacing-lg);
        }
        
        /* --- Weasel Guess Screen --- */
        #weasel-guess-screen .card {
            text-align: center;
        }
        
        #weasel-guess-screen h2 {
            margin-bottom: var(--spacing-md);
            color: var(--error-color);
        }
        
        #weasel-guess-screen p {
            margin-bottom: var(--spacing-lg);
            color: var(--text-secondary);
        }

        /* --- Additional spacing refinements --- */
        label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        h2 {
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        h3 {
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        p {
            margin-bottom: var(--spacing-sm);
            line-height: 1.6;
        }

        hr {
            margin: var(--spacing-md) 0;
            border: none;
            border-top: 1px solid var(--card-border);
        }

        #main-word-grid-container h3 {
            margin-bottom: var(--spacing-sm);
            text-align: center;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1>Word Weasel</h1>
            <p>A game of cunning clues & clever misdirection.</p>
        </header>
        <main>
            <!-- SETUP SCREEN -->
            <div id="setup-screen" class="screen active">
                <h2>Game Setup</h2>
                <div class="card">
                    <label for="player-count">How many players? (4+)</label>
                    <input type="number" id="player-count" min="4" max="10" value="4">
                    <div id="player-inputs"></div>
                </div>
                <button id="start-game-btn" class="btn">Start Game</button>
            </div>

            <!-- GAME SCREEN (Container for all active game phases) -->
            <div id="game-screen" class="screen">
                <div id="game-info-bar">
                    <span id="round-counter">Round 1 / 10</span>
                    <ul id="player-scores"></ul>
                </div>

                <div id="game-phase-container">
                    <!-- Pass Device Screen -->
                    <div id="pass-device-screen" class="screen">
                        <div class="card">
                            <h2 id="pass-to-player-name"></h2>
                            <p>Hand the device to the player above.</p>
                            <button id="show-role-btn" class="btn">Ready! Show My Role</button>
                        </div>
                    </div>
                    <!-- Role Reveal Screen -->
                    <div id="reveal-screen" class="screen">
                         <div class="card">
                            <h2 id="reveal-role-title"></h2>
                            <p id="reveal-instruction"></p>
                            <div id="reveal-word-grid" class="word-grid"></div>
                            <button id="role-revealed-btn" class="btn">I've Got It!</button>
                        </div>
                    </div>
                    <!-- Main Phase Screen (Clues, Wager, Verdict) -->
                    <div id="main-phase-screen" class="screen">
                        <div class="card">
                            <h2 id="phase-title"></h2>
                            <p id="phase-instruction"></p>
                            <div id="action-input-area"></div>
                            <button id="submit-action-btn" class="btn">Submit</button>
                        </div>
                        <div id="main-word-grid-container">
                            <h3>Word Grid</h3>
                            <div id="main-word-grid" class="word-grid"></div>
                        </div>
                    </div>
                     <!-- Buffer Screen -->
                    <div id="buffer-screen" class="screen">
                        <div class="card buffer-screen">
                            <h2>üîÑ Switching Players</h2>
                            <p>Please pass the device to the next player and ensure the previous player looks away.</p>
                            <button id="continue-buffer-btn" class="btn">Ready - Continue</button>
                        </div>
                    </div>
                    <!-- Vote Results Screen -->
                    <div id="vote-results-screen" class="screen">
                        <div class="card">
                            <h2>üìä Voting Results</h2>
                            <div id="vote-results-content">
                                <!-- Content generated by JS -->
                            </div>
                            <button id="continue-after-votes-btn" class="btn">Continue</button>
                        </div>
                    </div>
                    <!-- Weasel Guess Screen -->
                    <div id="weasel-guess-screen" class="screen">
                        <div class="card">
                            <h2 id="weasel-guess-title">üê≠ Weasel's Final Guess</h2>
                            <p id="weasel-guess-instruction">The Weasel must now guess the secret word from the grid below. Everyone can watch!</p>
                            <div id="weasel-guess-grid" class="word-grid"></div>
                            <button id="submit-weasel-guess-btn" class="btn" style="display: none;">Submit Guess</button>
                        </div>
                    </div>
                    
                    <!-- Scoring Screen -->
                    <div id="scoring-screen" class="screen">
                        <div id="scoring-summary" class="card">
                            <!-- Content generated by JS -->
                        </div>
                        <button id="next-round-btn" class="btn">Next Round</button>
                    </div>
                    <!-- Game Over Screen -->
                    <div id="game-over-screen" class="screen">
                        <div class="card">
                            <h2 id="game-over-title">Game Over!</h2>
                            <p id="winner-announcement"></p>
                            <button id="play-again-btn" class="btn">Play Again</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="rules-container">
                <details>
                    <summary>Show/Hide Full Game Rules</summary>
                    <div id="rules-content">
                        <h3>1. Game Overview</h3>
                        <p>In Word Weasel, players are divided into two secret teams each round: the <strong>Innocents</strong>, who know a secret word, and a single <strong>Weasel</strong>, who is left in the dark. The goal is to be the first to 100 points.</p>
                        <ul>
                            <li><strong>Players:</strong> 4+</li>
                            <li><strong>Roles:</strong> 1 Weasel, rest Innocents</li>
                            <li><strong>Starting Points:</strong> 50 per player</li>
                            <li><strong>Bet Range:</strong> 5‚Äì25 points</li>
                        </ul>
                        <h3>2. The Flow of a Round</h3>
                        <ol>
                            <li><strong>The Word Grid Reveal (Pass the Phone):</strong> The app privately shows each player the 3x6 Word Grid. Innocents see the Secret Word highlighted; the Weasel does not.</li>
                            <li><strong>Broad Clue Round (Verbal):</strong> Each player gives a single-word or short-phrase clue out loud.</li>
                            <li><strong>The Wager:</strong> All players secretly bet points. Innocents bet on catching the Weasel. The Weasel bets on guessing the word.</li>
                            <li><strong>Specific Clue Round (Verbal):</strong> Each player gives a second, more specific clue out loud.</li>
                            <li><strong>The Verdict:</strong> All players vote on who the Weasel is. The Weasel secretly guesses the word from the grid.</li>
                        </ol>
                        <h3>3. Scoring: The Interdependent Payout</h3>
                        <p>Payouts depend on two things: Did the Innocents catch the Weasel? (<strong>Catch Success</strong>) And did the Weasel guess the word? (<strong>Guess Success</strong>). A <strong>2x Sabotage Bonus</strong> is applied if your team succeeds AND the other team fails.</p>
                        <ul>
                            <li><strong>Scenario 1: Decisive Innocent Victory (Catch Success, Guess Failure)</strong><br>Innocents win their bets x2. Weasel loses (Catch Pot x2) + their own bet.</li>
                            <li><strong>Scenario 2: Masterful Weasel Victory (Catch Failure, Guess Success)</strong><br>Weasel wins (their bet x2) + the entire Catch Pot. Innocents lose their bets and must pay the Weasel's winnings.</li>
                            <li><strong>Scenario 3: A Contested Outcome (Catch Success, Guess Success)</strong><br>Bonuses are cancelled. Innocents win the Catch Pot (get their bets back). Weasel wins the Guess Pot (gets their bet back). Points are transferred between teams.</li>
                            <li><strong>Scenario 4: Total Failure (Catch Failure, Guess Failure)</strong><br>Nobody wins. All bets are lost and removed from the game.</li>
                        </ul>
                        <h3>4. End of the Game</h3>
                        <p>The game ends if a player reaches 100 points, a player's score hits 0, or after 10 rounds. The player with the highest score wins.</p>
                    </div>
                </details>
            </div>
        </main>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const playerCountInput = document.getElementById('player-count');
        const playerInputsContainer = document.getElementById('player-inputs');
        const startGameBtn = document.getElementById('start-game-btn');

        const screens = {
            setup: document.getElementById('setup-screen'),
            game: document.getElementById('game-screen'),
            passDevice: document.getElementById('pass-device-screen'),
            reveal: document.getElementById('reveal-screen'),
            mainPhase: document.getElementById('main-phase-screen'),
            buffer: document.getElementById('buffer-screen'),
            voteResults: document.getElementById('vote-results-screen'),
            weaselGuess: document.getElementById('weasel-guess-screen'),
            scoring: document.getElementById('scoring-screen'),
            gameOver: document.getElementById('game-over-screen')
        };
        
        const gameInfo = {
            roundCounter: document.getElementById('round-counter'),
            playerScores: document.getElementById('player-scores'),
            passToPlayerName: document.getElementById('pass-to-player-name'),
            showRoleBtn: document.getElementById('show-role-btn'),
            revealRoleTitle: document.getElementById('reveal-role-title'),
            revealInstruction: document.getElementById('reveal-instruction'),
            revealWordGrid: document.getElementById('reveal-word-grid'),
            roleRevealedBtn: document.getElementById('role-revealed-btn'),
            phaseTitle: document.getElementById('phase-title'),
            phaseInstruction: document.getElementById('phase-instruction'),
            actionInputArea: document.getElementById('action-input-area'),
            submitActionBtn: document.getElementById('submit-action-btn'),
            mainWordGrid: document.getElementById('main-word-grid'),
            scoringSummary: document.getElementById('scoring-summary'),
            nextRoundBtn: document.getElementById('next-round-btn'),
            gameOverTitle: document.getElementById('game-over-title'),
            winnerAnnouncement: document.getElementById('winner-announcement'),
            playAgainBtn: document.getElementById('play-again-btn'),
            continueBufferBtn: document.getElementById('continue-buffer-btn'),
            voteResultsContent: document.getElementById('vote-results-content'),
            continueAfterVotesBtn: document.getElementById('continue-after-votes-btn'),
            weaselGuessTitle: document.getElementById('weasel-guess-title'),
            weaselGuessInstruction: document.getElementById('weasel-guess-instruction'),
            weaselGuessGrid: document.getElementById('weasel-guess-grid'),
            submitWeaselGuessBtn: document.getElementById('submit-weasel-guess-btn')
        };

        // --- GAME STATE ---
        let gameState = {};

        const WORD_LISTS = {
            "Famous Landmarks": ["Eiffel Tower", "Statue of Liberty", "Great Wall", "Colosseum", "Taj Mahal", "Machu Picchu", "Pyramids of Giza", "Sydney Opera House", "Big Ben", "Christ the Redeemer", "Acropolis", "Stonehenge", "Mount Rushmore", "Burj Khalifa", "Petra", "Angkor Wat", "St. Basil's Cathedral", "Golden Gate Bridge"],
            "Movie Titles": ["The Godfather", "Pulp Fiction", "Forrest Gump", "The Matrix", "Inception", "Titanic", "Jurassic Park", "Star Wars", "The Avengers", "Jaws", "E.T.", "Back to the Future", "The Lion King", "Finding Nemo", "Toy Story", "Casablanca", "Psycho", "The Wizard of Oz"],
            "Types of Fruit": ["Apple", "Banana", "Orange", "Strawberry", "Grape", "Watermelon", "Pineapple", "Mango", "Peach", "Cherry", "Blueberry", "Raspberry", "Kiwi", "Lemon", "Avocado", "Pomegranate", "Coconut", "Pear"],
            "Animals": ["Lion", "Tiger", "Elephant", "Giraffe", "Zebra", "Kangaroo", "Penguin", "Dolphin", "Shark", "Eagle", "Owl", "Bear", "Wolf", "Fox", "Monkey", "Gorilla", "Hippo", "Crocodile"]
        };

        // --- GAME LOGIC ---

        function initializeGame() {
            const playerCount = parseInt(playerCountInput.value);
            const playerNames = Array.from(document.querySelectorAll('#player-inputs input')).map(input => input.value || `Player ${parseInt(input.dataset.index) + 1}`);

            gameState = {
                players: playerNames.map(name => ({
                    name: name,
                    score: 50,
                    weaselPoints: 0,
                    isWeasel: false,
                    bet: 0,
                    vote: null, // index of voted player
                })),
                currentRound: 0,
                maxRounds: 10,
                phase: 'setup', // setup, reveal, clue1, wager, clue2, verdict, scoring
                currentPlayerIndex: 0,
                wordGrid: [],
                secretWord: '',
                weaselIndex: -1,
                weaselGuess: '',
                votes: {},
            };
            
            startNewRound();
        }

        function startNewRound() {
            gameState.currentRound++;
            if (gameState.currentRound > gameState.maxRounds) {
                endGame("Max rounds reached.");
                return;
            }

            // Reset round-specific data
            gameState.players.forEach(p => {
                p.isWeasel = false;
                p.bet = 0;
                p.vote = null;
            });
            gameState.weaselGuess = '';
            gameState.votes = {};

            // Assign roles and word
            gameState.weaselIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.players[gameState.weaselIndex].isWeasel = true;

            const themes = Object.keys(WORD_LISTS);
            const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            const words = [...WORD_LISTS[randomTheme]];
            gameState.wordGrid = words;
            gameState.secretWord = words[Math.floor(Math.random() * words.length)];

            gameState.currentPlayerIndex = 0;
            gameState.phase = 'reveal';
            updateUI();
        }
        
        function nextPlayer() {
            gameState.currentPlayerIndex++;
            if (gameState.currentPlayerIndex >= gameState.players.length) {
                gameState.currentPlayerIndex = 0;
                advancePhase();
            }
            updateUI();
        }
        
        function advancePhase() {
            const phaseOrder = ['reveal', 'clue1', 'wager', 'clue2', 'verdict', 'voteResults', 'weaselGuess', 'scoring'];
            const currentPhaseIndex = phaseOrder.indexOf(gameState.phase);
            if (currentPhaseIndex !== -1 && currentPhaseIndex < phaseOrder.length - 1) {
                gameState.phase = phaseOrder[currentPhaseIndex + 1];
            }
        }
        
        function handleSubmitAction() {
            const player = gameState.players[gameState.currentPlayerIndex];
            
            switch(gameState.phase) {
                case 'clue1':
                case 'clue2':
                    // No input needed, just proceed
                    break;
                case 'wager':
                    const betInput = document.getElementById('bet-input');
                    const betAmount = parseInt(betInput.value);
                    if (isNaN(betAmount) || betAmount < 5) { alert("You must bet at least 5 points."); return; }
                    if (betAmount > 25 && player.score > 25) { alert("You can bet a maximum of 25 points."); return; }
                    if (betAmount > player.score) { alert("You cannot bet more points than you have."); return; }
                    player.bet = betAmount;
                    break;
                case 'verdict':
                    const selectedVote = document.querySelector('.vote-option.selected-vote');
                    if (!selectedVote) { alert("Please vote for a player."); return; }
                    player.vote = parseInt(selectedVote.dataset.index);
                    break;
            }
            
            if (gameState.phase === 'verdict' && gameState.currentPlayerIndex < gameState.players.length - 1) {
                // Show buffer screen between voting players
                gameState.phase = 'buffer';
                updateUI();
                return;
            }
            
            nextPlayer();
        }
        
        function continueFromBuffer() {
            gameState.phase = 'verdict';
            gameState.currentPlayerIndex++;
            updateUI();
        }
        
        function showVoteResults() {
            // Calculate vote results
            const voteCounts = {};
            gameState.players.forEach(p => {
                if (p.vote !== null) {
                    voteCounts[p.vote] = (voteCounts[p.vote] || 0) + 1;
                }
            });
            
            let maxVotes = 0;
            let accusedIndex = -1;
            for (const playerIndex in voteCounts) {
                if (voteCounts[playerIndex] > maxVotes) {
                    maxVotes = voteCounts[playerIndex];
                    accusedIndex = parseInt(playerIndex);
                }
            }
            
            // Display results
            let resultsHTML = '<h3>How everyone voted:</h3><ul style="text-align: left; margin: 20px 0;">';
            gameState.players.forEach((player, index) => {
                const votedFor = player.vote !== null ? gameState.players[player.vote].name : 'No vote';
                resultsHTML += `<li><strong>${player.name}</strong> voted for: ${votedFor}</li>`;
            });
            resultsHTML += '</ul>';
            
            if (accusedIndex !== -1) {
                const accusedPlayer = gameState.players[accusedIndex];
                resultsHTML += `<p style="font-size: 1.2em; margin: 20px 0;"><strong>Most votes: ${accusedPlayer.name} (${maxVotes} votes)</strong></p>`;
                
                if (accusedIndex === gameState.weaselIndex) {
                    resultsHTML += `<p style="color: var(--success-color); font-weight: bold;">‚úÖ The group caught the Weasel!</p>`;
                } else {
                    resultsHTML += `<p style="color: var(--error-color); font-weight: bold;">‚ùå The group accused an innocent player!</p>`;
                }
            } else {
                resultsHTML += `<p style="color: var(--warning-color); font-weight: bold;">‚ö†Ô∏è No clear majority vote!</p>`;
            }
            
            gameInfo.voteResultsContent.innerHTML = resultsHTML;
            gameState.accusedIndex = accusedIndex;
        }
        
        function setupWeaselGuess() {
            const weasel = gameState.players[gameState.weaselIndex];
            gameInfo.weaselGuessTitle.textContent = `üê≠ ${weasel.name}'s Final Guess`;
            gameInfo.weaselGuessInstruction.textContent = `${weasel.name} (the Weasel) must now guess the secret word. Everyone can watch!`;
            
            gameInfo.weaselGuessGrid.innerHTML = gameState.wordGrid.map(word => 
                `<div class="word-cell guessable" data-word="${word}">${word}</div>`
            ).join('');
            
            // Add click handlers for weasel guess
            document.querySelectorAll('#weasel-guess-grid .word-cell').forEach(cell => {
                cell.addEventListener('click', handleWeaselGuessSelection);
            });
            
            gameInfo.submitWeaselGuessBtn.style.display = 'none';
        }
        
        function handleWeaselGuessSelection(e) {
            document.querySelectorAll('#weasel-guess-grid .word-cell').forEach(cell => {
                cell.classList.remove('selected-guess');
            });
            e.target.classList.add('selected-guess');
            gameState.weaselGuess = e.target.dataset.word;
            gameInfo.submitWeaselGuessBtn.style.display = 'block';
        }
        
        function submitWeaselGuess() {
            if (!gameState.weaselGuess) {
                alert("Please select a word first!");
                return;
            }
            
            gameState.phase = 'scoring';
            updateUI();
        }
        
        function calculateScores() {
            // Use the stored accused index from vote results
            const catchSuccess = gameState.accusedIndex === gameState.weaselIndex;

            // Determine Guess Success
            const guessSuccess = gameState.weaselGuess && gameState.weaselGuess.toLowerCase() === gameState.secretWord.toLowerCase();
            
            const weasel = gameState.players[gameState.weaselIndex];
            const innocents = gameState.players.filter(p => !p.isWeasel);
            const catchPot = innocents.reduce((sum, p) => sum + p.bet, 0);
            const guessPot = weasel.bet;
            
            const changes = gameState.players.map(p => ({ name: p.name, change: 0, oldScore: p.score }));

            let outcomeKey;
            
            // Scenario 1: Decisive Innocent Victory (Catch Success, Guess Failure)
            if (catchSuccess && !guessSuccess) {
                outcomeKey = "innocent-win";
                // Innocents: Win their bets with a 2x Bonus
                innocents.forEach(p => {
                    const winnings = p.bet * 2;
                    p.score += winnings;
                    changes[gameState.players.indexOf(p)].change = winnings;
                });
                // Weasel: Loses the entire Catch Pot x 2 AND their own failed Guess Pot bet
                const weaselLoss = (catchPot * 2) + guessPot;
                weasel.score -= weaselLoss;
                changes[gameState.weaselIndex].change = -weaselLoss;
            }
            // Scenario 2: Masterful Weasel Victory (Catch Failure, Guess Success)
            else if (!catchSuccess && guessSuccess) {
                outcomeKey = "weasel-win";
                // Weasel: Wins their Guess Pot bet with a 2x Bonus AND wins the entire Catch Pot
                const weaselWinnings = (guessPot * 2) + catchPot;
                weasel.score += weaselWinnings;
                weasel.weaselPoints += weaselWinnings;
                changes[gameState.weaselIndex].change = weaselWinnings;

                // Innocents: Lose their bets from the Catch Pot AND must collectively pay the Weasel's winnings from the Guess Pot
                const weaselGuessPotWinnings = guessPot * 2; // The 2x bonus amount Weasel won from Guess Pot
                innocents.forEach(p => {
                    const innocentIndex = gameState.players.indexOf(p);
                    // Lose their bet from Catch Pot
                    let totalLoss = p.bet;
                    
                    // Pay proportional share of Weasel's Guess Pot winnings
                    if (catchPot > 0) {
                        const proportionalShare = (p.bet / catchPot) * weaselGuessPotWinnings;
                        totalLoss += proportionalShare;
                    }
                    
                    p.score -= totalLoss;
                    changes[innocentIndex].change = -totalLoss;
                });
            }
            // Scenario 3: A Contested Outcome (Catch Success, Guess Success)
            else if (catchSuccess && guessSuccess) {
                outcomeKey = "contested-win";
                // Innocents WIN the Catch Pot: Each gets their original bet back (net change = 0 from their own bet)
                // Weasel WINS the Guess Pot: Gets their original bet back (net change = 0 from their own bet)
                // The net transfer: Weasel pays Catch Pot, Innocents pay Guess Pot
                
                // Weasel pays out the Catch Pot but gets back their Guess Pot
                const weaselNetChange = guessPot - catchPot;
                weasel.score += weaselNetChange;
                if (weaselNetChange > 0) weasel.weaselPoints += weaselNetChange;
                changes[gameState.weaselIndex].change = weaselNetChange;

                // Each Innocent gets their bet back but pays proportional share of Guess Pot
                innocents.forEach(p => {
                    const innocentIndex = gameState.players.indexOf(p);
                    let netChange = p.bet; // Get their bet back from Catch Pot
                    
                    // Pay proportional share of Guess Pot
                    if (catchPot > 0) {
                        const proportionalPayment = (p.bet / catchPot) * guessPot;
                        netChange -= proportionalPayment;
                    }
                    
                    p.score += netChange;
                    changes[innocentIndex].change = netChange;
                });
            }
            // Scenario 4: Total Failure (Catch Failure, Guess Failure)
            else { // !catchSuccess && !guessSuccess
                outcomeKey = "total-failure";
                // All bets are lost and removed from the game
                gameState.players.forEach((p, i) => {
                    p.score -= p.bet;
                    changes[i].change = -p.bet;
                });
            }
            
            displayScoringSummary(outcomeKey, { catchSuccess, guessSuccess }, changes);
            checkEndConditions();
        }
        
        function checkEndConditions() {
            let gameOver = false;
            let reason = "";
            
            const highScorer = gameState.players.find(p => p.score >= 100);
            if (highScorer) {
                gameOver = true;
                reason = `${highScorer.name} reached 100 points!`;
            }
            
            const bankruptPlayer = gameState.players.find(p => p.score <= 0);
            if (bankruptPlayer) {
                gameOver = true;
                reason = `${bankruptPlayer.name} ran out of points!`;
            }

            if (gameOver) {
                endGame(reason);
            }
        }
        
        function endGame(reason) {
            gameState.phase = 'gameOver';
            
            let winners = [...gameState.players].sort((a, b) => b.score - a.score);
            let topScore = winners[0].score;
            let tiedWinners = winners.filter(p => p.score === topScore);
            
            let winner;
            if (tiedWinners.length > 1) {
                tiedWinners.sort((a, b) => b.weaselPoints - a.weaselPoints);
                winner = tiedWinners[0];
            } else {
                winner = winners[0];
            }
            
            gameInfo.winnerAnnouncement.innerHTML = `
                ${reason}<br>
                <strong>The winner is ${winner.name} with ${Math.round(winner.score)} points!</strong>
            `;
            updateUI();
        }

        // --- UI UPDATING ---
        
        function switchScreen(activeScreen) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[activeScreen]) {
                screens[activeScreen].classList.add('active');
            }
        }
        
        function updateUI() {
            if (gameState.phase === 'setup') {
                switchScreen('setup');
                return;
            }
            
            switchScreen('game');
            gameInfo.roundCounter.textContent = `Round ${gameState.currentRound} / ${gameState.maxRounds}`;
            gameInfo.playerScores.innerHTML = gameState.players.map(p => `<li class="${p.isWeasel && (gameState.phase === 'scoring' || gameState.phase === 'gameOver') ? 'weasel-score' : ''}">${p.name}: ${Math.round(p.score)}</li>`).join('');

            Object.values(screens).forEach(s => {
                if (s.parentElement === document.getElementById('game-phase-container')) s.classList.remove('active');
            });
            
            const player = gameState.players[gameState.currentPlayerIndex];
            
            switch(gameState.phase) {
                case 'reveal':
                    screens.passDevice.classList.add('active');
                    gameInfo.passToPlayerName.textContent = `Pass to ${player.name}`;
                    break;
                    
                case 'clue1':
                case 'wager':
                case 'clue2':
                case 'verdict':
                    screens.mainPhase.classList.add('active');
                    setupMainPhaseScreen();
                    break;
                    
                case 'buffer':
                    screens.buffer.classList.add('active');
                    break;
                    
                case 'voteResults':
                    screens.voteResults.classList.add('active');
                    showVoteResults();
                    break;
                    
                case 'weaselGuess':
                    screens.weaselGuess.classList.add('active');
                    setupWeaselGuess();
                    break;
                    
                case 'scoring':
                    screens.scoring.classList.add('active');
                    calculateScores();
                    break;

                case 'gameOver':
                    screens.gameOver.classList.add('active');
                    break;
            }
        }
        
        function showRevealScreen() {
            switchScreen('game');
            screens.reveal.classList.add('active');
            
            const player = gameState.players[gameState.currentPlayerIndex];
            gameInfo.revealRoleTitle.textContent = player.isWeasel ? "You are the WEASEL!" : "You are an INNOCENT";
            gameInfo.revealInstruction.textContent = player.isWeasel 
                ? "You DON'T know the secret word. Blend in and try to figure it out from the clues!"
                : "Your team's secret word is highlighted below. Give clues to help your fellow Innocents find the Weasel without giving the word away!";
            
            gameInfo.revealWordGrid.innerHTML = gameState.wordGrid.map(word => 
                `<div class="word-cell ${!player.isWeasel && word === gameState.secretWord ? 'secret' : ''}">${word}</div>`
            ).join('');
        }
        
        function setupMainPhaseScreen() {
            const player = gameState.players[gameState.currentPlayerIndex];
            let title = '', instruction = '', inputHTML = '', buttonText = 'Submit';
            
            switch(gameState.phase) {
                case 'clue1':
                    title = `Clue 1: ${player.name}'s Turn`;
                    instruction = "Give your BROAD clue out loud to the group. When you are finished, press 'Continue'.";
                    inputHTML = ``;
                    buttonText = "Continue";
                    break;
                case 'wager':
                    title = `Wager: ${player.name}'s Turn`;
                    instruction = `All clues for round 1 have been given. Secretly place your bet. Your current score: ${Math.round(player.score)}`;
                    inputHTML = `<input type="number" id="bet-input" min="5" max="${Math.min(25, player.score)}" placeholder="Bet 5-25 points">`;
                    buttonText = "Submit Bet";
                    break;
                case 'clue2':
                    title = `Clue 2: ${player.name}'s Turn`;
                    instruction = "Give your SPECIFIC clue out loud to the group. When you are finished, press 'Continue'.";
                    inputHTML = ``;
                    buttonText = "Continue";
                    break;
                case 'verdict':
                    title = `Verdict: ${player.name}'s Turn`;
                    instruction = "All clues have been given. Now, vote for who you think the Weasel is.";
                    inputHTML = `<ul id="vote-options">` + gameState.players
                        .map((p, i) => `<li class="vote-option" data-index="${i}">${p.name}</li>`)
                        .join('') + `</ul>`;
                    buttonText = "Submit Vote";
                    break;
            }
            
            gameInfo.phaseTitle.textContent = title;
            gameInfo.phaseInstruction.textContent = instruction;
            gameInfo.actionInputArea.innerHTML = inputHTML;
            gameInfo.submitActionBtn.textContent = buttonText;
            
            gameInfo.mainWordGrid.innerHTML = gameState.wordGrid.map(word => 
                `<div class="word-cell">${word}</div>`
            ).join('');
            
            if (gameState.phase === 'verdict') {
                document.querySelectorAll('.vote-option').forEach(opt => opt.addEventListener('click', handleVoteSelection));
            }
        }

        function handleVoteSelection(e) {
            document.querySelectorAll('.vote-option').forEach(opt => opt.classList.remove('selected-vote'));
            e.target.classList.add('selected-vote');
        }
        
        function handleGuessSelection(e) {
            document.querySelectorAll('.word-cell.guessable').forEach(cell => cell.classList.remove('selected-guess'));
            e.target.classList.add('selected-guess');
        }

        function displayScoringSummary(outcomeKey, results, changes) {
            const outcomeTitles = {
                "innocent-win": "Decisive Innocent Victory!",
                "weasel-win": "Masterful Weasel Victory!",
                "contested-win": "Contested Outcome!",
                "total-failure": "Total Failure!"
            };

            const outcomeDescriptions = {
                "innocent-win": "The Innocents caught the Weasel, and the Weasel failed to guess the word. <strong>Innocents get a 2x bonus!</strong>",
                "weasel-win": "The Weasel escaped and guessed the secret word! <strong>The Weasel gets a 2x bonus and steals the Catch Pot!</strong>",
                "contested-win": "The Innocents caught the Weasel, but the Weasel ALSO guessed the word. <strong>Bonuses are cancelled.</strong>",
                "total-failure": "The Innocents failed to catch the Weasel, AND the Weasel failed to guess. <strong>Everybody loses their bets!</strong>"
            };

            const scoreChangesHTML = changes.map(c => {
                const change = Math.round(c.change * 100) / 100;
                const changeClass = change > 0 ? 'score-gain' : (change < 0 ? 'score-loss' : '');
                const sign = change > 0 ? '+' : '';
                return `<li><span>${c.name}</span> <strong class="${changeClass}">${sign}${change} pts</strong> ( ${Math.round(c.oldScore)} ‚Üí ${Math.round(c.oldScore + change)} )</li>`;
            }).join('');

            gameInfo.scoringSummary.innerHTML = `
                <h2 class="outcome-title ${outcomeKey}">${outcomeTitles[outcomeKey]}</h2>
                <p><strong>The Secret Word was:</strong> ${gameState.secretWord}</p>
                <p><strong>The Weasel was:</strong> ${gameState.players[gameState.weaselIndex].name}</p>
                <p><strong>Catch Attempt:</strong> ${results.catchSuccess ? 'SUCCESS' : 'FAILURE'}</p>
                <p><strong>Weasel's Guess:</strong> "${gameState.weaselGuess || 'No Guess Made'}" (${results.guessSuccess ? 'SUCCESS' : 'FAILURE'})</p>
                <hr style="margin: 15px 0; border-color: var(--primary-color);">
                <p>${outcomeDescriptions[outcomeKey]}</p>
                <h3>Score Changes:</h3>
                <ul id="player-score-changes">
                    ${scoreChangesHTML}
                </ul>
            `;
        }
        
        // --- EVENT LISTENERS ---
        playerCountInput.addEventListener('change', () => {
            const count = parseInt(playerCountInput.value);
            playerInputsContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                playerInputsContainer.innerHTML += `
                    <div class="player-input-group">
                        <input type="text" placeholder="Player ${i + 1} Name" data-index="${i}">
                    </div>
                `;
            }
        });
        
        startGameBtn.addEventListener('click', initializeGame);
        
        gameInfo.showRoleBtn.addEventListener('click', () => {
            if (gameState.phase === 'reveal') {
                showRevealScreen();
            } else if (gameState.phase === 'verdict') {
                // Show the voting screen for the current player
                screens.passDevice.classList.remove('active');
                screens.mainPhase.classList.add('active');
                setupMainPhaseScreen();
            }
        });
        
        gameInfo.roleRevealedBtn.addEventListener('click', () => {
            screens.reveal.classList.remove('active');
            nextPlayer();
        });
        
        gameInfo.submitActionBtn.addEventListener('click', handleSubmitAction);
        
        gameInfo.nextRoundBtn.addEventListener('click', startNewRound);
        
        gameInfo.playAgainBtn.addEventListener('click', () => {
            location.reload();
        });
        
        gameInfo.continueBufferBtn.addEventListener('click', continueFromBuffer);
        
        gameInfo.continueAfterVotesBtn.addEventListener('click', () => {
            gameState.phase = 'weaselGuess';
            updateUI();
        });
        
        gameInfo.submitWeaselGuessBtn.addEventListener('click', submitWeaselGuess);

        // --- INITIALIZE ---
        playerCountInput.dispatchEvent(new Event('change'));

    </script>
</body>
</html>