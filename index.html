<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Weasel - The Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Charmonman:wght@400;700&family=Cherry+Swash:wght@400;700&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Apple-inspired Color Palette */
            --primary-color: #213448;
            --primary-light: #2E465E;
            --primary-dark: #1A2A38;
            --secondary-color: #FF9500;
            --secondary-light: #FFAD33;
            --secondary-dark: #CC7700;
            --accent-color: #34C759;
            --accent-light: #5DD87C;
            --accent-dark: #28A745;
            --warning-color: #FF3B30;
            --warning-light: #FF6B61;
            --warning-dark: #CC2E24;
            
            /* Neutral Colors */
            --neutral-white: #FFFFFF;
            --neutral-50: #FAFAFA;
            --neutral-100: #F5F5F7;
            --neutral-200: #E5E5EA;
            --neutral-300: #D1D1D6;
            --neutral-400: #C7C7CC;
            --neutral-500: #AEAEB2;
            --neutral-600: #8E8E93;
            --neutral-700: #636366;
            --neutral-800: #48484A;
            --neutral-900: #1C1C1E;
            
            /* Semantic Colors */
            --text-primary: var(--neutral-900);
            --text-secondary: var(--neutral-700);
            --text-tertiary: var(--neutral-600);
            --text-on-primary: var(--neutral-white);
            --text-on-color: var(--neutral-white);
            
            --background-primary: var(--neutral-white);
            --background-secondary: var(--neutral-50);
            --background-tertiary: var(--neutral-100);
            
            --border-light: var(--neutral-200);
            --border-medium: var(--neutral-300);
            --border-strong: var(--neutral-400);
            
            --surface-elevated: var(--neutral-white);
            --surface-overlay: rgba(0, 0, 0, 0.04);
            
            /* Shadows */
            --shadow-small: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-large: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* Layout */
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-2xl: 24px;
            --spacing-3xl: 32px;
            --spacing-4xl: 40px;
            
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 400;
            background: var(--background-secondary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: var(--spacing-lg);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--background-primary);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-large);
            overflow: hidden;
        }

        header {
            background: var(--primary-color);
            padding: var(--spacing-3xl) var(--spacing-2xl) var(--spacing-xl);
            text-align: center;
        }

        header h1 {
            font-family: 'Charmonman', cursive;
            font-size: 45px;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            color: var(--text-on-primary);
            letter-spacing: -0.5px;
        }

        header p {
            font-size: 16px;
            color: var(--text-on-primary);
            font-weight: 400;
            opacity: 0.8;
        }

        main {
            padding: var(--spacing-3xl) var(--spacing-2xl);
        }

        /* Typography */
        h1, h2, h3 {
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 24px;
            margin-bottom: var(--spacing-xl);
        }

        h3 {
            font-size: 20px;
            margin-bottom: var(--spacing-lg);
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--surface-elevated);
            border: 1px solid var(--border-light);
            padding: var(--spacing-2xl);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-small);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            color: var(--text-on-primary);
            font-weight: 600;
            font-size: 16px;
            padding: var(--spacing-lg) var(--spacing-2xl);
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            margin-top: var(--spacing-xl);
            min-height: 48px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--secondary-color);
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
        }

        .btn-success {
            background: var(--accent-color);
        }

        .btn-success:hover {
            background: var(--accent-dark);
        }

        .btn-danger {
            background: var(--warning-color);
        }

        .btn-danger:hover {
            background: var(--warning-dark);
        }

        /* Form Elements */
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-medium);
            background: var(--background-primary);
            color: var(--text-primary);
            font-size: 16px;
            transition: var(--transition);
            min-height: 48px;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 52, 72, 0.1);
        }

        input::placeholder {
            color: var(--text-tertiary);
        }

        input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Player Setup */
        #player-inputs {
            margin: var(--spacing-xl) 0;
        }

        .player-input-group {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            align-items: center;
        }

        .player-input-group::before {
            content: 'üë§';
            font-size: 24px;
            opacity: 0.6;
            width: 48px;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 48px;
            line-height: 1;
            padding-bottom: 18px;
        }

        /* Game Info Bar */
        #game-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-xl) var(--spacing-2xl);
            background: var(--background-tertiary);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--spacing-xl);
        }

        #round-counter {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-secondary);
        }

        #player-scores {
            list-style: none;
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        #player-scores li {
            font-weight: 500;
            font-size: 14px;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--background-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            color: var(--text-primary);
        }

        #player-scores .weasel-score {
            background: var(--warning-color);
            color: var(--text-on-color);
            border-color: var(--warning-color);
            font-weight: 600;
        }

        /* Word Grid */
        #word-grid, #main-word-grid, #reveal-word-grid, #weasel-guess-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .word-cell {
            background: var(--background-tertiary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid var(--border-light);
            transition: var(--transition);
            color: var(--text-primary);
            cursor: default;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .word-cell.secret {
            background: var(--secondary-color);
            color: var(--text-on-color);
            font-weight: 600;
            border-color: var(--secondary-color);
        }

        .word-cell.guessable {
            cursor: pointer;
        }

        .word-cell.guessable:hover {
            background: var(--primary-color);
            color: var(--text-on-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .word-cell.selected-guess {
            background: var(--accent-color);
            color: var(--text-on-color);
            border-color: var(--accent-color);
            font-weight: 600;
        }

        @media (min-width: 768px) {
            #word-grid, #main-word-grid, #reveal-word-grid, #weasel-guess-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        /* Vote Options */
        #vote-options {
            list-style: none;
            margin-top: var(--spacing-xl);
            display: grid;
            gap: var(--spacing-md);
        }

        .vote-option {
            background: var(--background-tertiary);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-light);
            font-weight: 500;
            color: var(--text-primary);
            min-height: 48px;
            display: flex;
            align-items: center;
        }

        .vote-option:hover {
            background: var(--primary-color);
            color: var(--text-on-color);
            border-color: var(--primary-color);
        }

        .vote-option.selected-vote {
            background: var(--primary-color);
            color: var(--text-on-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* Scoring Summary */
        #scoring-summary {
            text-align: left;
        }

        #scoring-summary h2 {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .outcome-title {
            font-weight: 700;
            font-size: 20px;
            text-align: center;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--spacing-xl);
        }

        .innocent-win { 
            background: var(--accent-color);
            color: var(--text-on-color);
        }
        .weasel-win { 
            background: var(--warning-color);
            color: var(--text-on-color);
        }
        .contested-win { 
            background: var(--secondary-color);
            color: var(--text-on-color);
        }
        .total-failure { 
            background: var(--neutral-700);
            color: var(--text-on-color);
        }

        #player-score-changes {
            list-style: none;
            margin-top: var(--spacing-xl);
            background: var(--background-tertiary);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        #player-score-changes li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg) var(--spacing-xl);
            border-bottom: 1px solid var(--border-light);
        }

        #player-score-changes li:last-child {
            border-bottom: none;
        }

        .score-gain { 
            color: var(--accent-color);
            font-weight: 600;
        }
        .score-loss { 
            color: var(--warning-color); 
            font-weight: 600;
        }

        /* Rules Section */
        #rules-container {
            margin-top: var(--spacing-4xl);
        }

        #rules-container summary {
            cursor: pointer;
            padding: var(--spacing-xl);
            background: var(--background-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 16px;
            outline: none;
            transition: var(--transition);
            user-select: none;
            color: var(--text-primary);
        }

        #rules-container summary:hover {
            background: var(--background-primary);
            border-color: var(--border-medium);
        }

        #rules-container details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
        }

        #rules-content {
            background: var(--background-primary);
            padding: var(--spacing-xl);
            border: 1px solid var(--border-light);
            border-top: none;
            border-bottom-left-radius: var(--border-radius-lg);
            border-bottom-right-radius: var(--border-radius-lg);
            text-align: left;
            line-height: 1.6;
            color: var(--text-primary);
        }

        #rules-content h3 {
            color: var(--primary-color);
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            font-weight: 600;
        }

        #rules-content ul, #rules-content ol {
            padding-left: var(--spacing-xl);
            margin: var(--spacing-md) 0;
        }

        #rules-content li {
            margin-bottom: var(--spacing-sm);
        }

        #rules-content strong {
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* Special Screens */
        .buffer-screen {
            text-align: center;
        }

        .buffer-screen h2 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-secondary);
        }

        .buffer-screen p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
        }

        #weasel-guess-screen .card {
            text-align: center;
        }

        #weasel-guess-screen h2 {
            margin-bottom: var(--spacing-lg);
            color: var(--warning-color);
        }

        #weasel-guess-screen p {
            margin-bottom: var(--spacing-xl);
            color: var(--text-secondary);
        }

        /* Additional Elements */
        label {
            display: block;
            margin-bottom: var(--spacing-md);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        /* Timer Styles */
        #timer-container {
            display: none;
            text-align: center;
            margin: var(--spacing-xl) 0;
            padding: var(--spacing-lg);
            background: var(--background-tertiary);
            border-radius: var(--border-radius-lg);
            border: 2px solid var(--border-light);
        }

        #timer-container.active {
            display: block;
        }

        #timer-display {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
        }

        #timer-display.warning {
            color: var(--warning-color);
            animation: pulse 1s infinite;
        }

        #timer-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }

            header {
                padding: var(--spacing-2xl) var(--spacing-lg);
            }

            header h1 {
                font-size: 24px;
            }

            main {
                padding: var(--spacing-2xl) var(--spacing-lg);
            }

            .card {
                padding: var(--spacing-xl);
            }

            #game-info-bar {
                flex-direction: column;
                gap: var(--spacing-lg);
                text-align: center;
                padding: var(--spacing-lg);
            }

            #player-scores {
                justify-content: center;
                gap: var(--spacing-md);
            }

            .word-cell {
                font-size: 13px;
                padding: var(--spacing-md);
            }
        }

        /* Focus Styles */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1>Word Weasel</h1>
            <p>A game of cunning clues & clever misdirection.</p>
        </header>
        <main>
            <!-- SETUP SCREEN -->
            <div id="setup-screen" class="screen active">
                <h2>Game Setup</h2>
                <div class="card">
                    <label for="player-count">How many players? (4+)</label>
                    <input type="number" id="player-count" min="4" max="10" value="4">
                    <div id="player-inputs"></div>
                </div>
                <button id="start-game-btn" class="btn">Start Game</button>
            </div>

            <!-- GAME SCREEN (Container for all active game phases) -->
            <div id="game-screen" class="screen">
                <div id="game-info-bar">
                    <span id="round-counter">Round 1 / 10</span>
                    <ul id="player-scores"></ul>
                </div>

                <div id="game-phase-container">
                    <!-- Pass Device Screen -->
                    <div id="pass-device-screen" class="screen">
                        <div class="card">
                            <h2 id="pass-to-player-name"></h2>
                            <p>Hand the device to the player above.</p>
                            <button id="show-role-btn" class="btn">Ready! Show My Role</button>
                        </div>
                    </div>
                    <!-- Role Reveal Screen -->
                    <div id="reveal-screen" class="screen">
                         <div class="card">
                            <h2 id="reveal-role-title"></h2>
                            <p id="reveal-instruction"></p>
                            <div id="reveal-word-grid" class="word-grid"></div>
                            <button id="role-revealed-btn" class="btn">I've Got It!</button>
                        </div>
                    </div>
                    <!-- Main Phase Screen (Clues, Wager, Verdict) -->
                    <div id="main-phase-screen" class="screen">
                        <div class="card">
                            <h2 id="phase-title"></h2>
                            <p id="phase-instruction"></p>
                            <div id="timer-container">
                                <div id="timer-display">0:20</div>
                                <div id="timer-label">Time Remaining</div>
                            </div>
                            <div id="action-input-area"></div>
                            <button id="submit-action-btn" class="btn">Submit</button>
                        </div>
                        <div id="main-word-grid-container">
                            <h3>Word Grid</h3>
                            <div id="main-word-grid" class="word-grid"></div>
                        </div>
                    </div>
                     <!-- Buffer Screen -->
                    <div id="buffer-screen" class="screen">
                        <div class="card buffer-screen">
                            <h2>üîÑ Pass to ${nextPlayer.name}</h2>
                            <p>Please hand the device to ${nextPlayer.name} and ensure the previous player looks away.</p>
                            <button id="continue-buffer-btn" class="btn">Ready - Continue</button>
                        </div>
                    </div>
                    <!-- Vote Results Screen -->
                    <div id="vote-results-screen" class="screen">
                        <div class="card">
                            <h2>üìä Voting Results</h2>
                            <div id="vote-results-content">
                                <!-- Content generated by JS -->
                            </div>
                            <button id="continue-after-votes-btn" class="btn">Reveal the Weasel!</button>
                        </div>
                    </div>
                    <!-- Weasel Reveal Screen -->
                    <div id="weasel-reveal-screen" class="screen">
                        <div class="card">
                            <h2>üé≠ The Moment of Truth</h2>
                            <div id="weasel-reveal-content">
                                <!-- Content generated by JS -->
                            </div>
                            <button id="continue-to-guess-btn" class="btn">Continue to Weasel's Guess</button>
                        </div>
                    </div>
                    <!-- Weasel Guess Screen -->
                    <div id="weasel-guess-screen" class="screen">
                        <div class="card">
                            <h2 id="weasel-guess-title">üê≠ Weasel's Final Guess</h2>
                            <p id="weasel-guess-instruction">The Weasel must now guess the secret word from the grid below. Everyone can watch!</p>
                            <div id="weasel-guess-grid" class="word-grid"></div>
                            <button id="submit-weasel-guess-btn" class="btn" style="display: none;">Submit Guess</button>
                        </div>
                    </div>
                    
                    <!-- Scoring Screen -->
                    <div id="scoring-screen" class="screen">
                        <div id="scoring-summary" class="card">
                            <!-- Content generated by JS -->
                        </div>
                        <button id="next-round-btn" class="btn">Next Round</button>
                    </div>
                    <!-- Game Over Screen -->
                    <div id="game-over-screen" class="screen">
                        <div class="card">
                            <h2 id="game-over-title">Game Over!</h2>
                            <p id="winner-announcement"></p>
                            <button id="play-again-btn" class="btn">Play Again</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="rules-container">
                <details>
                    <summary>Game Rules</summary>
                    <div id="rules-content">
                        <h3>1. Game Overview</h3>
                        <p>In Word Weasel, players are divided into two secret teams each round: the <strong>Owls</strong>, who know a secret word, and a single <strong>Weasel</strong>, who is left in the dark. The goal is to be the first to 25 ü™µ twigs.</p>
                        <ul>
                            <li><strong>Players:</strong> 4+</li>
                            <li><strong>Roles:</strong> 1 Weasel, rest Owls</li>
                            <li><strong>Starting Twigs:</strong> 10 ü™µ per player</li>
                            <li><strong>Bet Range:</strong> 1‚Äì3 ü™µ twigs</li>
                        </ul>
                        <h3>2. The Flow of a Round</h3>
                        <ol>
                            <li><strong>The Word Grid Reveal (Pass the Phone):</strong> The app privately shows each player the 3x6 Word Grid. Owls see the Secret Word highlighted; the Weasel does not.</li>
                            <li><strong>Broad Clue Round (Verbal):</strong> Each player gives a single-word or short-phrase clue out loud.</li>
                            <li><strong>The Wager:</strong> All players secretly bet ü™µ twigs. Owls bet on catching the Weasel. The Weasel bets on guessing the word.</li>
                            <li><strong>Specific Clue Round (Verbal):</strong> Each player gives a second, more specific clue out loud.</li>
                            <li><strong>The Verdict:</strong> All players vote on who the Weasel is. The Weasel secretly guesses the word from the grid.</li>
                        </ol>
                        <h3>3. Scoring: The Interdependent Payout</h3>
                        <p>Payouts depend on two things: Did the Owls catch the Weasel? (<strong>Catch Success</strong>) And did the Weasel guess the word? (<strong>Guess Success</strong>). A <strong>2x Sabotage Bonus</strong> is applied if your team succeeds AND the other team fails.</p>
                        <ul>
                            <li><strong>Scenario 1: Decisive Owl Victory (Catch Success, Guess Failure)</strong><br>Owls win their bets x2. Weasel loses their bet.</li>
                            <li><strong>Scenario 2: Masterful Weasel Victory (Catch Failure, Guess Success)</strong><br>Weasel wins their bet x3. Owls lose their bets.</li>
                            <li><strong>Scenario 3: A Contested Outcome (Catch Success, Guess Success)</strong><br>Bonuses are cancelled. Everyone gets their bets back.</li>
                            <li><strong>Scenario 4: Total Failure (Catch Failure, Guess Failure)</strong><br>Nobody wins. All bets are lost and removed from the game.</li>
                        </ul>
                        <h3>4. End of the Game</h3>
                        <p>The game ends if a player reaches 25 ü™µ twigs, a player's score hits 0, or after 10 rounds. The player with the highest score wins.</p>
                    </div>
                </details>
            </div>
        </main>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const playerCountInput = document.getElementById('player-count');
        const playerInputsContainer = document.getElementById('player-inputs');
        const startGameBtn = document.getElementById('start-game-btn');

        const screens = {
            setup: document.getElementById('setup-screen'),
            game: document.getElementById('game-screen'),
            passDevice: document.getElementById('pass-device-screen'),
            reveal: document.getElementById('reveal-screen'),
            mainPhase: document.getElementById('main-phase-screen'),
            buffer: document.getElementById('buffer-screen'),
            voteResults: document.getElementById('vote-results-screen'),
            weaselReveal: document.getElementById('weasel-reveal-screen'),
            weaselGuess: document.getElementById('weasel-guess-screen'),
            scoring: document.getElementById('scoring-screen'),
            gameOver: document.getElementById('game-over-screen')
        };
        
        const gameInfo = {
            roundCounter: document.getElementById('round-counter'),
            playerScores: document.getElementById('player-scores'),
            passToPlayerName: document.getElementById('pass-to-player-name'),
            showRoleBtn: document.getElementById('show-role-btn'),
            revealRoleTitle: document.getElementById('reveal-role-title'),
            revealInstruction: document.getElementById('reveal-instruction'),
            revealWordGrid: document.getElementById('reveal-word-grid'),
            roleRevealedBtn: document.getElementById('role-revealed-btn'),
            phaseTitle: document.getElementById('phase-title'),
            phaseInstruction: document.getElementById('phase-instruction'),
            actionInputArea: document.getElementById('action-input-area'),
            submitActionBtn: document.getElementById('submit-action-btn'),
            mainWordGrid: document.getElementById('main-word-grid'),
            scoringSummary: document.getElementById('scoring-summary'),
            nextRoundBtn: document.getElementById('next-round-btn'),
            gameOverTitle: document.getElementById('game-over-title'),
            winnerAnnouncement: document.getElementById('winner-announcement'),
            playAgainBtn: document.getElementById('play-again-btn'),
            continueBufferBtn: document.getElementById('continue-buffer-btn'),
            voteResultsContent: document.getElementById('vote-results-content'),
            continueAfterVotesBtn: document.getElementById('continue-after-votes-btn'),
            weaselRevealContent: document.getElementById('weasel-reveal-content'),
            continueToGuessBtn: document.getElementById('continue-to-guess-btn'),
            weaselGuessTitle: document.getElementById('weasel-guess-title'),
            weaselGuessInstruction: document.getElementById('weasel-guess-instruction'),
            weaselGuessGrid: document.getElementById('weasel-guess-grid'),
            submitWeaselGuessBtn: document.getElementById('submit-weasel-guess-btn')
        };

        // --- GAME STATE ---
        let gameState = {};
        let timerInterval = null;
        let currentTimerSeconds = 0;

        const WORD_LISTS = {
            "Famous Landmarks": ["Eiffel Tower", "Statue of Liberty", "Great Wall", "Colosseum", "Taj Mahal", "Machu Picchu", "Pyramids of Giza", "Sydney Opera House", "Big Ben", "Christ the Redeemer", "Acropolis", "Stonehenge", "Mount Rushmore", "Burj Khalifa", "Petra", "Angkor Wat", "St. Basil's Cathedral", "Golden Gate Bridge"],
            "Movie Titles": ["The Godfather", "Pulp Fiction", "Forrest Gump", "The Matrix", "Inception", "Titanic", "Jurassic Park", "Star Wars", "The Avengers", "Jaws", "E.T.", "Back to the Future", "The Lion King", "Finding Nemo", "Toy Story", "Casablanca", "Psycho", "The Wizard of Oz"],
            "Types of Fruit": ["Apple", "Banana", "Orange", "Strawberry", "Grape", "Watermelon", "Pineapple", "Mango", "Peach", "Cherry", "Blueberry", "Raspberry", "Kiwi", "Lemon", "Avocado", "Pomegranate", "Coconut", "Pear"],
            "Animals": ["Lion", "Tiger", "Elephant", "Giraffe", "Zebra", "Kangaroo", "Penguin", "Dolphin", "Shark", "Eagle", "Owl", "Bear", "Wolf", "Fox", "Monkey", "Gorilla", "Hippo", "Crocodile"]
        };

        // --- GAME LOGIC ---

        function initializeGame() {
            const playerCount = parseInt(playerCountInput.value);
            const playerNames = Array.from(document.querySelectorAll('#player-inputs input')).map(input => input.value || `Player ${parseInt(input.dataset.index) + 1}`);

            gameState = {
                players: playerNames.map(name => ({
                    name: name,
                    score: 10,
                    weaselPoints: 0,
                    isWeasel: false,
                    bet: 0,
                    vote: null, // index of voted player
                })),
                currentRound: 0,
                maxRounds: 10,
                phase: 'setup', // setup, reveal, clue1, wager, clue2, verdict, scoring
                currentPlayerIndex: 0,
                wordGrid: [],
                secretWord: '',
                weaselIndex: -1,
                weaselGuess: '',
                votes: {},
            };
            
            startNewRound();
        }

        function startNewRound() {
            gameState.currentRound++;
            if (gameState.currentRound > gameState.maxRounds) {
                endGame("Max rounds reached.");
                return;
            }

            // Reset round-specific data
            gameState.players.forEach(p => {
                p.isWeasel = false;
                p.bet = 0;
                p.vote = null;
            });
            gameState.weaselGuess = '';
            gameState.votes = {};

            // Assign roles and word
            gameState.weaselIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.players[gameState.weaselIndex].isWeasel = true;

            const themes = Object.keys(WORD_LISTS);
            const randomTheme = themes[Math.floor(Math.random() * themes.length)];
            const words = [...WORD_LISTS[randomTheme]];
            gameState.wordGrid = words;
            gameState.secretWord = words[Math.floor(Math.random() * words.length)];

            gameState.currentPlayerIndex = 0;
            gameState.phase = 'reveal';
            updateUI();
        }
        
        function nextPlayer() {
            gameState.currentPlayerIndex++;
            if (gameState.currentPlayerIndex >= gameState.players.length) {
                gameState.currentPlayerIndex = 0;
                advancePhase();
            }
            updateUI();
        }
        
        function advancePhase() {
            const phaseOrder = ['reveal', 'clue1', 'wager', 'clue2', 'verdict', 'voteResults', 'weaselReveal', 'weaselGuess', 'scoring'];
            const currentPhaseIndex = phaseOrder.indexOf(gameState.phase);
            if (currentPhaseIndex !== -1 && currentPhaseIndex < phaseOrder.length - 1) {
                gameState.phase = phaseOrder[currentPhaseIndex + 1];
                
                // Add transition screens before private phases
                if (gameState.phase === 'wager' || gameState.phase === 'verdict') {
                    gameState.phase = `transition-${gameState.phase}`;
                }
            }
        }
        
        function handleSubmitAction() {
            const player = gameState.players[gameState.currentPlayerIndex];
            
            switch(gameState.phase) {
                case 'clue1':
                case 'clue2':
                    // No input needed, just proceed
                    break;
                case 'wager':
                    const betInput = document.getElementById('bet-input');
                    const betAmount = parseInt(betInput.value);
                    if (isNaN(betAmount) || betAmount < 1) { alert("You must bet at least 1 ü™µ twig."); return; }
                    if (betAmount > 3 && player.score > 3) { alert("You can bet a maximum of 3 ü™µ twigs."); return; }
                    if (betAmount > player.score) { alert("You cannot bet more ü™µ twigs than you have."); return; }
                    player.bet = betAmount;
                    break;
                case 'verdict':
                    const selectedVote = document.querySelector('.vote-option.selected-vote');
                    if (!selectedVote) { alert("Please vote for a player."); return; }
                    player.vote = parseInt(selectedVote.dataset.index);
                    break;
            }
            
            // Check if we need to show buffer screen between players for private phases
            if ((gameState.phase === 'wager' || gameState.phase === 'verdict') && gameState.currentPlayerIndex < gameState.players.length - 1) {
                // Store current phase info before going to buffer
                gameState.previousPhase = gameState.phase;
                gameState.phase = 'buffer';
                updateUI();
                return;
            }
            
            nextPlayer();
        }
        
        function continueFromBuffer() {
            // Determine which phase to return to based on what we were doing before the buffer
            if (gameState.currentPlayerIndex < gameState.players.length - 1) {
                // Still have more players for the current phase
                gameState.currentPlayerIndex++;
                // Return to the phase we were in before the buffer
                if (gameState.phase === 'buffer') {
                    // Check if we have any players with bets set but not all players
                    const playersWithBets = gameState.players.filter(p => p.bet > 0).length;
                    const playersWithVotes = gameState.players.filter(p => p.vote !== null).length;
                    
                    if (playersWithBets > 0 && playersWithBets < gameState.players.length) {
                        gameState.phase = 'wager';
                    } else if (playersWithVotes > 0 && playersWithVotes < gameState.players.length) {
                        gameState.phase = 'verdict';
                    }
                }
            } else {
                // This was the last player, advance to next phase
                gameState.currentPlayerIndex = 0;
                advancePhase();
            }
            updateUI();
        }
        
        function showVoteResults() {
            // Calculate vote results
            const voteCounts = {};
            gameState.players.forEach(p => {
                if (p.vote !== null) {
                    voteCounts[p.vote] = (voteCounts[p.vote] || 0) + 1;
                }
            });
            
            let maxVotes = 0;
            let accusedIndex = -1;
            for (const playerIndex in voteCounts) {
                if (voteCounts[playerIndex] > maxVotes) {
                    maxVotes = voteCounts[playerIndex];
                    accusedIndex = parseInt(playerIndex);
                }
            }
            
            // Display results
            let resultsHTML = '<h3>How everyone voted:</h3><ul style="text-align: left; margin: 20px 0;">';
            gameState.players.forEach((player, index) => {
                const votedFor = player.vote !== null ? gameState.players[player.vote].name : 'No vote';
                resultsHTML += `<li><strong>${player.name}</strong> voted for: ${votedFor}</li>`;
            });
            resultsHTML += '</ul>';
            
            if (accusedIndex !== -1) {
                const accusedPlayer = gameState.players[accusedIndex];
                resultsHTML += `<p style="font-size: 1.2em; margin: 20px 0;"><strong>Most votes: ${accusedPlayer.name} (${maxVotes} votes)</strong></p>`;
            } else {
                resultsHTML += `<p style="color: var(--warning-color); font-weight: bold;">‚ö†Ô∏è No clear majority vote!</p>`;
            }
            
            gameInfo.voteResultsContent.innerHTML = resultsHTML;
            gameState.accusedIndex = accusedIndex;
        }
        
        function showWeaselReveal() {
            const weasel = gameState.players[gameState.weaselIndex];
            const accusedIndex = gameState.accusedIndex;
            const catchSuccess = accusedIndex === gameState.weaselIndex;
            
            let revealHTML = '';
            
            if (accusedIndex !== -1) {
                const accusedPlayer = gameState.players[accusedIndex];
                
                revealHTML += `<div style="margin-bottom: var(--spacing-xl);">`;
                revealHTML += `<h3 style="text-align: center; margin-bottom: var(--spacing-lg); color: var(--text-secondary);">The Vote Results</h3>`;
                revealHTML += `<div style="background: var(--neutral-200); padding: var(--spacing-lg); border-radius: var(--border-radius); text-align: center; margin-bottom: var(--spacing-lg);">`;
                revealHTML += `<p style="margin-bottom: var(--spacing-sm);">The group accused:</p>`;
                revealHTML += `<p style="font-size: 1.2em; font-weight: 600; color: var(--primary-color);">${accusedPlayer.name}</p>`;
                revealHTML += `</div>`;
                revealHTML += `</div>`;
                
                revealHTML += `<div style="margin-bottom: var(--spacing-xl);">`;
                revealHTML += `<h3 style="text-align: center; margin-bottom: var(--spacing-lg); color: var(--text-secondary);">The Truth</h3>`;
                revealHTML += `<div style="background: var(--secondary-gradient); color: var(--text-on-secondary); padding: var(--spacing-lg); border-radius: var(--border-radius); text-align: center; margin-bottom: var(--spacing-lg);">`;
                revealHTML += `<p style="margin-bottom: var(--spacing-sm);">The actual Weasel was:</p>`;
                revealHTML += `<p style="font-size: 1.2em; font-weight: 700;">üê≠ ${weasel.name}</p>`;
                revealHTML += `</div>`;
                revealHTML += `</div>`;
                
                if (catchSuccess) {
                    revealHTML += `<div style="background: var(--accent-gradient); color: var(--text-on-accent); padding: var(--spacing-md); border-radius: var(--border-radius); text-align: center; font-weight: 600;">`;
                    revealHTML += `‚úÖ The Owls successfully caught the Weasel!`;
                    revealHTML += `</div>`;
                } else {
                    revealHTML += `<div style="background: var(--warning-gradient); color: var(--text-on-warning); padding: var(--spacing-md); border-radius: var(--border-radius); text-align: center; font-weight: 600;">`;
                    revealHTML += `‚ùå The Weasel escaped detection`;
                    revealHTML += `</div>`;
                }
            } else {
                revealHTML += `<div style="margin-bottom: var(--spacing-xl);">`;
                revealHTML += `<h3 style="text-align: center; margin-bottom: var(--spacing-lg); color: var(--text-secondary);">The Vote Results</h3>`;
                revealHTML += `<div style="background: var(--neutral-200); padding: var(--spacing-lg); border-radius: var(--border-radius); text-align: center; margin-bottom: var(--spacing-lg);">`;
                revealHTML += `<p style="color: var(--warning-color); font-weight: 600;">No clear majority vote</p>`;
                revealHTML += `</div>`;
                revealHTML += `</div>`;
                
                revealHTML += `<div style="margin-bottom: var(--spacing-xl);">`;
                revealHTML += `<h3 style="text-align: center; margin-bottom: var(--spacing-lg); color: var(--text-secondary);">The Truth</h3>`;
                revealHTML += `<div style="background: var(--secondary-gradient); color: var(--text-on-secondary); padding: var(--spacing-lg); border-radius: var(--border-radius); text-align: center; margin-bottom: var(--spacing-lg);">`;
                revealHTML += `<p style="margin-bottom: var(--spacing-sm);">The Weasel was:</p>`;
                revealHTML += `<p style="font-size: 1.2em; font-weight: 700;">üê≠ ${weasel.name}</p>`;
                revealHTML += `</div>`;
                revealHTML += `</div>`;
                
                revealHTML += `<div style="background: var(--warning-gradient); color: var(--text-on-warning); padding: var(--spacing-md); border-radius: var(--border-radius); text-align: center; font-weight: 600;">`;
                revealHTML += `‚ùå The Weasel escaped due to voting confusion`;
                revealHTML += `</div>`;
            }
            
            gameInfo.weaselRevealContent.innerHTML = revealHTML;
        }
        
        function setupWeaselGuess() {
            const weasel = gameState.players[gameState.weaselIndex];
            gameInfo.weaselGuessTitle.textContent = `üê≠ ${weasel.name}'s Final Guess`;
            gameInfo.weaselGuessInstruction.textContent = `${weasel.name} (the Weasel) must now guess the secret word. Everyone can watch!`;
            
            gameInfo.weaselGuessGrid.innerHTML = gameState.wordGrid.map(word => 
                `<div class="word-cell guessable" data-word="${word}">${word}</div>`
            ).join('');
            
            // Add click handlers for weasel guess
            document.querySelectorAll('#weasel-guess-grid .word-cell').forEach(cell => {
                cell.addEventListener('click', handleWeaselGuessSelection);
            });
            
            gameInfo.submitWeaselGuessBtn.style.display = 'none';
        }
        
        function handleWeaselGuessSelection(e) {
            document.querySelectorAll('#weasel-guess-grid .word-cell').forEach(cell => {
                cell.classList.remove('selected-guess');
            });
            e.target.classList.add('selected-guess');
            gameState.weaselGuess = e.target.dataset.word;
            gameInfo.submitWeaselGuessBtn.style.display = 'block';
        }
        
        function submitWeaselGuess() {
            if (!gameState.weaselGuess) {
                alert("Please select a word first!");
                return;
            }
            
            gameState.phase = 'scoring';
            updateUI();
        }
        
        function calculateScores() {
            // Use the stored accused index from vote results
            const catchSuccess = gameState.accusedIndex === gameState.weaselIndex;

            // Determine Guess Success
            const guessSuccess = gameState.weaselGuess && gameState.weaselGuess.toLowerCase() === gameState.secretWord.toLowerCase();
            
            const weasel = gameState.players[gameState.weaselIndex];
            const innocents = gameState.players.filter(p => !p.isWeasel);
            
            const changes = gameState.players.map(p => ({ name: p.name, change: 0, oldScore: p.score }));

            let outcomeKey;
            
            // Scenario 1: Only Owls win (Catch Success, Guess Failure)
            if (catchSuccess && !guessSuccess) {
                outcomeKey = "innocent-win";
                // Owls: Win 2x their stake for successful catch bet
                innocents.forEach(p => {
                    const winnings = p.bet * 2;
                    p.score += winnings;
                    changes[gameState.players.indexOf(p)].change = winnings;
                });
                // Weasel: Loses their failed guess bet
                weasel.score -= weasel.bet;
                changes[gameState.weaselIndex].change = -weasel.bet;
            }
            // Scenario 2: Only Weasel wins (Catch Failure, Guess Success)
            else if (!catchSuccess && guessSuccess) {
                outcomeKey = "weasel-win";
                // Weasel: Wins 3x their stake for successful guess bet
                const weaselWinnings = weasel.bet * 3;
                weasel.score += weaselWinnings;
                weasel.weaselPoints += weaselWinnings;
                changes[gameState.weaselIndex].change = weaselWinnings;

                // Owls: Lose their failed catch bets
                innocents.forEach(p => {
                    const innocentIndex = gameState.players.indexOf(p);
                    p.score -= p.bet;
                    changes[innocentIndex].change = -p.bet;
                });
            }
            // Scenario 3: Both sides win - Push (Catch Success, Guess Success)
            else if (catchSuccess && guessSuccess) {
                outcomeKey = "contested-win";
                // Everyone gets back exactly what they wagered (1x) - net change is 0
                // No score changes needed since everyone "pushes"
                gameState.players.forEach((p, i) => {
                    changes[i].change = 0;
                });
            }
            // Scenario 4: Both sides lose (Catch Failure, Guess Failure)
            else { // !catchSuccess && !guessSuccess
                outcomeKey = "total-failure";
                // Everyone loses their bet
                gameState.players.forEach((p, i) => {
                    p.score -= p.bet;
                    changes[i].change = -p.bet;
                });
            }
            
            displayScoringSummary(outcomeKey, { catchSuccess, guessSuccess }, changes);
            checkEndConditions();
        }
        
        function checkEndConditions() {
            let gameOver = false;
            let reason = "";
            
            const highScorer = gameState.players.find(p => p.score >= 25);
            if (highScorer) {
                gameOver = true;
                reason = `${highScorer.name} reached 25 ü™µ twigs!`;
            }
            
            const bankruptPlayer = gameState.players.find(p => p.score <= 0);
            if (bankruptPlayer) {
                gameOver = true;
                reason = `${bankruptPlayer.name} ran out of ü™µ twigs!`;
            }

            if (gameOver) {
                endGame(reason);
            }
        }
        
        function endGame(reason) {
            gameState.phase = 'gameOver';
            
            let winners = [...gameState.players].sort((a, b) => b.score - a.score);
            let topScore = winners[0].score;
            let tiedWinners = winners.filter(p => p.score === topScore);
            
            let winner;
            if (tiedWinners.length > 1) {
                tiedWinners.sort((a, b) => b.weaselPoints - a.weaselPoints);
                winner = tiedWinners[0];
            } else {
                winner = winners[0];
            }
            
            gameInfo.winnerAnnouncement.innerHTML = `
                ${reason}<br>
                <strong>The winner is ${winner.name} with ${Math.round(winner.score)} ü™µ twigs!</strong>
            `;
            updateUI();
        }

        function startTimer(seconds) {
            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            currentTimerSeconds = seconds;
            const timerContainer = document.getElementById('timer-container');
            const timerDisplay = document.getElementById('timer-display');
            const timerLabel = document.getElementById('timer-label');
            
            // Show timer
            timerContainer.classList.add('active');
            
            // Update display
            function updateTimerDisplay() {
                const minutes = Math.floor(currentTimerSeconds / 60);
                const seconds = currentTimerSeconds % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Add warning style when under 6 seconds
                if (currentTimerSeconds <= 5) {
                    timerDisplay.classList.add('warning');
                } else {
                    timerDisplay.classList.remove('warning');
                }
                
                timerLabel.textContent = 'Time Remaining';
            }
            
            // Initial display
            updateTimerDisplay();
            
            // Start countdown
            timerInterval = setInterval(() => {
                currentTimerSeconds--;
                updateTimerDisplay();
                
                if (currentTimerSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = '0:00';
                    timerLabel.textContent = 'Time Up!';
                    timerDisplay.classList.add('warning');
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            const timerContainer = document.getElementById('timer-container');
            timerContainer.classList.remove('active');
        }

        // --- UI UPDATING ---
        
        function switchScreen(activeScreen) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            if (screens[activeScreen]) {
                screens[activeScreen].classList.add('active');
            }
        }
        
        function updateUI() {
            if (gameState.phase === 'setup') {
                switchScreen('setup');
                return;
            }
            
            switchScreen('game');
            gameInfo.roundCounter.textContent = `Round ${gameState.currentRound} / ${gameState.maxRounds}`;
            gameInfo.playerScores.innerHTML = gameState.players.map(p => `<li class="${p.isWeasel && (gameState.phase === 'scoring' || gameState.phase === 'gameOver') ? 'weasel-score' : ''}">${p.name}: ${Math.round(p.score)} ü™µ</li>`).join('');

            Object.values(screens).forEach(s => {
                if (s.parentElement === document.getElementById('game-phase-container')) s.classList.remove('active');
            });
            
            const player = gameState.players[gameState.currentPlayerIndex];
            
            switch(gameState.phase) {
                case 'reveal':
                    screens.passDevice.classList.add('active');
                    gameInfo.passToPlayerName.textContent = `Pass to ${player.name}`;
                    break;
                
                case 'transition-wager':
                case 'transition-verdict':
                    screens.passDevice.classList.add('active');
                    const phaseType = gameState.phase.replace('transition-', '');
                    const phaseNames = { wager: 'Wagering', verdict: 'Voting' };
                    gameInfo.passToPlayerName.textContent = `${phaseNames[phaseType]}: Pass to ${player.name}`;
                    break;
                    
                case 'clue1':
                case 'wager':
                case 'clue2':
                case 'verdict':
                    screens.mainPhase.classList.add('active');
                    setupMainPhaseScreen();
                    break;
                    
                case 'buffer':
                    screens.buffer.classList.add('active');
                    // Update buffer screen with next player info
                    const nextPlayerIndex = gameState.currentPlayerIndex + 1;
                    if (nextPlayerIndex < gameState.players.length) {
                        const nextPlayer = gameState.players[nextPlayerIndex];
                        document.querySelector('#buffer-screen h2').textContent = `üîÑ Pass to ${nextPlayer.name}`;
                        document.querySelector('#buffer-screen p').textContent = `Please hand the device to ${nextPlayer.name} and ensure the previous player looks away.`;
                    }
                    break;
                    
                case 'voteResults':
                    screens.voteResults.classList.add('active');
                    showVoteResults();
                    break;
                    
                case 'weaselReveal':
                    screens.weaselReveal.classList.add('active');
                    showWeaselReveal();
                    break;
                    
                case 'weaselGuess':
                    screens.weaselGuess.classList.add('active');
                    setupWeaselGuess();
                    break;
                    
                case 'scoring':
                    screens.scoring.classList.add('active');
                    calculateScores();
                    break;

                case 'gameOver':
                    screens.gameOver.classList.add('active');
                    break;
            }
        }
        
        function showRevealScreen() {
            switchScreen('game');
            screens.reveal.classList.add('active');
            
            const player = gameState.players[gameState.currentPlayerIndex];
            gameInfo.revealRoleTitle.textContent = player.isWeasel ? "You are the WEASEL!" : "You are an OWL";
            gameInfo.revealInstruction.textContent = player.isWeasel 
                ? "You DON'T know the secret word. Blend in and try to figure it out from the clues!"
                : "Your team's secret word is highlighted below. Give clues to help your fellow Owls find the Weasel without giving the word away!";
            
            gameInfo.revealWordGrid.innerHTML = gameState.wordGrid.map(word => 
                `<div class="word-cell ${!player.isWeasel && word === gameState.secretWord ? 'secret' : ''}">${word}</div>`
            ).join('');
        }
        
        function setupMainPhaseScreen() {
            const player = gameState.players[gameState.currentPlayerIndex];
            let title = '', instruction = '', inputHTML = '', buttonText = 'Submit';
            
            // Stop any existing timer first
            stopTimer();
            
            switch(gameState.phase) {
                case 'clue1':
                    title = `Clue 1: ${player.name}'s Turn`;
                    instruction = "Give your BROAD clue out loud to the group. You have 20 seconds. When you are finished, press 'Continue'.";
                    inputHTML = ``;
                    buttonText = "Continue";
                    // Start 20-second timer for clue phase
                    setTimeout(() => startTimer(20), 100);
                    break;
                case 'wager':
                    title = `Wager: ${player.name}'s Turn`;
                    if (player.isWeasel) {
                        instruction = `You are the Weasel. Bet on your ability to guess the secret word. Your current score: ${Math.round(player.score)} ü™µ twigs`;
                    } else {
                        instruction = `You are an Owl. Bet on your team's ability to catch the Weasel. Your current score: ${Math.round(player.score)} ü™µ twigs`;
                    }
                    inputHTML = `<input type="number" id="bet-input" min="1" max="${Math.min(3, player.score)}" placeholder="Bet 1-3 ü™µ twigs">`;
                    buttonText = "Submit Bet";
                    break;
                case 'clue2':
                    title = `Clue 2: ${player.name}'s Turn`;
                    instruction = "Give your SPECIFIC clue out loud to the group. You have 20 seconds. When you are finished, press 'Continue'.";
                    inputHTML = ``;
                    buttonText = "Continue";
                    // Start 20-second timer for clue phase
                    setTimeout(() => startTimer(20), 100);
                    break;
                case 'verdict':
                    title = `Verdict: ${player.name}'s Turn`;
                    instruction = "All clues have been given. Now, vote for who you think the Weasel is.";
                    inputHTML = `<ul id="vote-options">` + gameState.players
                        .map((p, i) => `<li class="vote-option" data-index="${i}">${p.name}</li>`)
                        .join('') + `</ul>`;
                    buttonText = "Submit Vote";
                    break;
            }
            
            gameInfo.phaseTitle.textContent = title;
            gameInfo.phaseInstruction.textContent = instruction;
            gameInfo.actionInputArea.innerHTML = inputHTML;
            gameInfo.submitActionBtn.textContent = buttonText;
            
            gameInfo.mainWordGrid.innerHTML = gameState.wordGrid.map(word => 
                `<div class="word-cell">${word}</div>`
            ).join('');
            
            if (gameState.phase === 'verdict') {
                document.querySelectorAll('.vote-option').forEach(opt => opt.addEventListener('click', handleVoteSelection));
            }
        }

        function handleVoteSelection(e) {
            document.querySelectorAll('.vote-option').forEach(opt => opt.classList.remove('selected-vote'));
            e.target.classList.add('selected-vote');
        }
        
        function handleGuessSelection(e) {
            document.querySelectorAll('.word-cell.guessable').forEach(cell => cell.classList.remove('selected-guess'));
            e.target.classList.add('selected-guess');
        }

        function displayScoringSummary(outcomeKey, results, changes) {
            const outcomeTitles = {
                "innocent-win": "Owls Win!",
                "weasel-win": "Weasel Wins!",
                "contested-win": "Push - Both Sides Win!",
                "total-failure": "Total Failure - Everyone Loses!"
            };

            const outcomeDescriptions = {
                "innocent-win": "The Owls caught the Weasel, and the Weasel failed to guess the word. <strong>Owls win 2√ó their catch bets!</strong>",
                "weasel-win": "The Weasel escaped detection and guessed the secret word! <strong>The Weasel wins 3√ó their guess bet!</strong>",
                "contested-win": "The Owls caught the Weasel, but the Weasel ALSO guessed the word correctly. <strong>Everyone pushes and gets back their original bet (1√ó).</strong>",
                "total-failure": "The Owls failed to catch the Weasel, AND the Weasel failed to guess the word. <strong>Everyone loses their bets!</strong>"
            };

            const scoreChanges = changes.map(c => {
                const change = Math.round(c.change * 100) / 100;
                const changeClass = change > 0 ? 'score-gain' : (change < 0 ? 'score-loss' : '');
                const sign = change > 0 ? '+' : '';
                return `<li><span>${c.name}</span> <strong class="${changeClass}">${sign}${change} ü™µ twigs</strong> ( ${Math.round(c.oldScore)} ‚Üí ${Math.round(c.oldScore + change)} )</li>`;
            }).join('');

            gameInfo.scoringSummary.innerHTML = `
                <h2 class="outcome-title ${outcomeKey}">${outcomeTitles[outcomeKey]}</h2>
                <p><strong>The Secret Word was:</strong> ${gameState.secretWord}</p>
                <p><strong>The Weasel was:</strong> ${gameState.players[gameState.weaselIndex].name}</p>
                <p><strong>Catch Attempt:</strong> ${results.catchSuccess ? 'SUCCESS' : 'FAILURE'}</p>
                <p><strong>Weasel's Guess:</strong> "${gameState.weaselGuess || 'No Guess Made'}" (${results.guessSuccess ? 'SUCCESS' : 'FAILURE'})</p>
                <hr style="margin: 15px 0; border-color: var(--primary-color);">
                <p>${outcomeDescriptions[outcomeKey]}</p>
                <h3>Score Changes:</h3>
                <ul id="player-score-changes">
                    ${scoreChanges}
                </ul>
            `;
        }
        
        // --- EVENT LISTENERS ---
        playerCountInput.addEventListener('change', () => {
            const count = parseInt(playerCountInput.value);
            playerInputsContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                playerInputsContainer.innerHTML += `
                    <div class="player-input-group">
                        <input type="text" placeholder="Player ${i + 1} Name" data-index="${i}">
                    </div>
                `;
            }
        });
        
        startGameBtn.addEventListener('click', initializeGame);
        
        gameInfo.showRoleBtn.addEventListener('click', () => {
            if (gameState.phase === 'reveal') {
                showRevealScreen();
            } else if (gameState.phase === 'transition-wager') {
                // Transition from wager handoff to actual wager screen
                gameState.phase = 'wager';
                updateUI();
            } else if (gameState.phase === 'transition-verdict') {
                // Transition from verdict handoff to actual verdict screen
                gameState.phase = 'verdict';
                updateUI();
            }
        });
        
        gameInfo.roleRevealedBtn.addEventListener('click', () => {
            screens.reveal.classList.remove('active');
            nextPlayer();
        });
        
        gameInfo.submitActionBtn.addEventListener('click', handleSubmitAction);
        
        gameInfo.nextRoundBtn.addEventListener('click', startNewRound);
        
        gameInfo.playAgainBtn.addEventListener('click', () => {
            location.reload();
        });
        
        gameInfo.continueBufferBtn.addEventListener('click', continueFromBuffer);
        
        gameInfo.continueAfterVotesBtn.addEventListener('click', () => {
            gameState.phase = 'weaselReveal';
            updateUI();
        });
        
        gameInfo.continueToGuessBtn.addEventListener('click', () => {
            gameState.phase = 'weaselGuess';
            updateUI();
        });
        
        gameInfo.submitWeaselGuessBtn.addEventListener('click', submitWeaselGuess);

        // --- INITIALIZE ---
        playerCountInput.dispatchEvent(new Event('change'));

    </script>
</body>
</html>